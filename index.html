<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diff Tool</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' text-anchor='middle' dominant-baseline='central' font-size='48'>↔️</text></svg>">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/merge/merge.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/merge/merge.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">

    <style>
        html, body {
            height: 100%;
        }
        body {
            min-height: 100vh;
            margin: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 15px;
            background-color: #f8f9fa;
            color: #212529;
            gap: 15px;
        }
        .header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }
        h1 { margin: 0; }
        .controls { display: flex; align-items: center; gap: 15px; }
        label { font-weight: bold; }
        #languageSelector, #themeSelector {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: #fff;
            font-size: 14px;
        }
        #clearButton {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: #f8d7da;
            color: #721c24;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            border: 1px solid #dee2e6;
        }
        .editor-headers {
            flex-shrink: 0;
            display: flex;
            justify-content: space-around;
            background-color: #e9ecef;
            padding: 8px 0;
            font-weight: bold;
        }
        #diffView {
            flex: 1;
            overflow: auto; /* Ensures CodeMirror is contained */
        }
        .CodeMirror-merge {
            height: 100%;
        }
        .CodeMirror-merge-gap {
            width: 40px !important;
        }
        .CodeMirror {
            height: 100% !important;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Diff Tool ↔️</h1>
        <div class="controls">
            <button id="clearButton" aria-label="Clear both editors">Clear Content</button>
            <label for="languageSelector">Language:</label>
            <select id="languageSelector" aria-label="Select language">
                <option value="javascript" selected>JavaScript</option>
                <option value="python">Python</option>
                <option value="yaml">YAML</option>
                <option value="application/json">JSON</option>
                <option value="text/x-go">Go</option>
                <option value="text/x-rustsrc">Rust</option>
                <option value="text/typescript">TypeScript</option>
                <option value="text/x-java">Java</option>
                <option value="text/x-csharp">C#</option>
                <option value="xml">HTML/XML</option>
                <option value="css">CSS</option>
                <option value="sql">SQL</option>
                <option value="shell">Shell</option>
                <option value="text/plain">Plain Text</option>
            </select>
            <label for="themeSelector">Theme:</label>
            <select id="themeSelector" aria-label="Select theme">
                <option value="eclipse" selected>Eclipse</option>
                <option value="dracula">Dracula</option>
                <option value="monokai">Monokai</option>
            </select>
        </div>
    </div>
    
    <div class="editor-container">
        <div class="editor-headers">
            <div>Original</div>
            <div>Updated</div>
        </div>
        <div id="diffView"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Use a minimal timeout to ensure layout is complete
            setTimeout(() => {
                const diffViewContainer = document.getElementById('diffView');
                const languageSelector = document.getElementById('languageSelector');
                const themeSelector = document.getElementById('themeSelector');
                const clearButton = document.getElementById('clearButton');

                const savedLeft = localStorage.getItem('diffToolContentLeft') || '';
                const savedRight = localStorage.getItem('diffToolContentRight') || '';
                const savedTheme = localStorage.getItem('diffToolTheme') || 'eclipse';

                // Improvement: `loadedModes` is now outside `setLanguage` to persist state
                const loadedModes = new Set();

                const mergeView = CodeMirror.MergeView(diffViewContainer, {
                    value: savedLeft,
                    orig: savedRight,
                    lineNumbers: true,
                    mode: languageSelector.value,
                    theme: savedTheme,
                    highlightDifferences: true,
                    connect: "align",
                    allowEditingOriginals: true,
                });

                themeSelector.value = savedTheme;

                function debounce(func, delay) {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                }

                async function setLanguage(mode) {
                    async function loadLanguageScript(modeToLoad) {
                        let language = modeToLoad.split('/').pop().split('-').pop();
                        if (language === 'json') language = 'javascript'; // JSON uses JS mode
                        if (language === 'application') language = 'javascript';

                        if (loadedModes.has(language)) return;

                        return new Promise((resolve) => {
                            const script = document.createElement('script');
                            script.src = `https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/${language}/${language}.min.js`;
                            script.onload = () => { loadedModes.add(language); resolve(true); };
                            // Improvement: Better error handling
                            script.onerror = () => {
                                console.warn(`Failed to load mode script for: ${language}`);
                                resolve(false); // Don't reject, just signal failure
                            };
                            document.head.appendChild(script);
                        });
                    }

                    const success = await loadLanguageScript(mode);
                    const finalMode = success ? mode : "text/plain";
                    mergeView.edit.setOption("mode", finalMode);
                    if (mergeView.right.orig) {
                        mergeView.right.orig.setOption("mode", finalMode);
                    }
                }

                function detectAndSetLanguage() {
                    const code = mergeView.edit.getValue();
                    if (code.trim().length < 10) {
                        setLanguage(languageSelector.value);
                        return;
                    }
                    
                    const sample = code.substring(0, 500);
                    const result = hljs.highlightAuto(sample, ['javascript', 'python', 'yaml', 'json', 'go', 'rust', 'java', 'cs', 'xml', 'css', 'sql', 'shell']);
                    const langMap = { "js": "javascript", "html": "xml", "cs": "text/x-csharp", "java": "text/x-java", "ts": "text/typescript", "json": "application/json", "rs": "text/x-rustsrc" };
                    const detectedLang = langMap[result.language] || result.language;
                    const option = Array.from(languageSelector.options).find(opt => opt.value === detectedLang);

                    if (option) {
                        languageSelector.value = option.value;
                        setLanguage(option.value);
                    } else {
                        setLanguage(languageSelector.value);
                    }
                }

                languageSelector.addEventListener('change', () => {
                    setLanguage(languageSelector.value);
                });

                // Improvement: Theme selector logic
                themeSelector.addEventListener('change', () => {
                    const theme = themeSelector.value;
                    mergeView.edit.setOption("theme", theme);
                    if (mergeView.right.orig) {
                        mergeView.right.orig.setOption("theme", theme);
                    }
                    localStorage.setItem('diffToolTheme', theme);
                });

                const debouncedSave = debounce(() => {
                    localStorage.setItem('diffToolContentLeft', mergeView.edit.getValue());
                    localStorage.setItem('diffToolContentRight', mergeView.right.orig.getValue());
                }, 300);
                
                const debouncedDetect = debounce(detectAndSetLanguage, 400);

                mergeView.edit.on("change", () => {
                    debouncedSave();
                    debouncedDetect();
                });
                if (mergeView.right.orig) {
                    mergeView.right.orig.on("change", debouncedSave);
                }

                clearButton.addEventListener('click', () => {
                    mergeView.edit.setValue('');
                    if (mergeView.right.orig) {
                        mergeView.right.orig.setValue('');
                    }
                    localStorage.removeItem('diffToolContentLeft');
                    localStorage.removeItem('diffToolContentRight');
                });

                // Initial setup on load
                detectAndSetLanguage();

            }, 0);
        });
    </script>

</body>
</html>